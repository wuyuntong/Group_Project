---
title: "COVID19 contraction and deathes analysis"
format: html
editor: visual
author: Yuntong Wu & Jiaxin Shen
---

## Links

Github link: <https://github.com/wuyuntong/Group_Project>

Sources links:

Health data: <https://www.countyhealthrankings.org/explore-health-rankings/rankings-data-documentation>

Covid data: <https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/>

Social-economic data: <https://www.ers.usda.gov/data-products/county-level-data-sets/county-level-data-sets-download-data/>

## Description of data sources

The data we selected comes from the following three websites:

1.Health data: The file analytic_data2021 comes from the County Health Rankings & Roadmaps (CHR&R) County Health Rankings & Roadmaps (CHR&R) is a program of the University of Wisconsin Population Health Institute. The CHR&R program provides data, evidence, guidance, and examples to build awareness of the multiple factors that influence health and support leaders in growing community power to improve health equity. The Rankings measure the health of nearly every county in all 50 states.

This file provides various health-related data indicators for U.S. counties in 2021, including health behaviors, clinical care, as well as social and economic factors. We plan to select 8 of the variables (Adult smoking, Adult obesity, Food environment index, Physical inactivity, Excessive, drinking, Uninsured, Primary care physicians and Violent crime}as measures of residents' health levels and study whether there is a correlation between these variables and the covid numbers.

2.Covid data: The files covid_confirmed_usafacts and covid_deaths_usafacts come from USAFacts, which dedicated to providing comprehensive, real-time pandemic data from all 50 states especially the data on hotspots and infection rates.

These two files provide respectively the daily data on confirmed cases and deaths from the epidemic by county in the United States from January 2020 to July 2023. We will combine daily data into monthly data to to make the data more intuitive and representative. The covid confirmed cases number and covid death number are the main target variables of our analysis.

3.Social-economic data: These four files Education, PopulationEstimates, PovertyEstimates and Unemployment come from USDA's & Economic Research Service, which anticipate trends and emerging issues in agriculture, food, the environment, and rural America and to conduct high-quality, objective economic research to inform and enhance public and private decision making.

The file Education provides the basic information on the educational attainment of counties in the United States from 2017 to 2021. We mainly select the variable "Percent of adults with age bachelor's degree or higher" to analyze whether there is a correlation between the educational attainment of counties in the United States and the number of confirmed cases.

PopulationEstimates provides the estimated number of population by county in the United States from 2020 to 2022. We choose the two variables of birth rate and death rate in 2021 as analysis indicators.

The data form PovertyEstimates are model-based estimates from the U.S. Census Bureau's Small Area Income and Poverty Estimate (SAIPE) program. This file includes the estimated poverty data of counties in the United States in 2021, and we select the Estimated percent of people of all ages in poverty 2021 as the research variable.

Unemployment includes overall employment status by county in the United States from 2000 to 2022. We mainly choose the unemployment rate and median household income to measure the employment level of each county, and use these two variables to study whether there is a correlation between the poverty level and the number of confirmed cases.

## Description of variables
Below is the description of variables that are used in the project. For other variables, we refer interested readers to the data sources.

countyFIPS: Federal Information Processing Standard (FIPS) Code.

State: State abbreviation.

County Name: county names.

case_mon: containing cumulative COVID-19 confirmed cases number as of the end of each month from July 2020 to June 2021.

death_mon: containing cumulative COVID-19 death number as of the end of each month from July 2020 to June 2021.

Smoke: Percentage of adults who are current smokers (age-adjusted).

Obesity: Percentage of the adult population (age 20 and older) that reports a body mass index (BMI) greater than or equal to 30 kg/m2.

Food_environment index: Index of factors that contribute to a healthy food environment, from 0 (worst) to 10 (best).

Physical inactivity r: Percentage of adults age 20 and over reporting no leisure-time physical activity.

Drink: Percentage of adults reporting binge or heavy drinking (age-adjusted).

Uninsured: Percentage of population under age 65 without health insurance.

Primary care: Number of primary care physicians per 100,000 population.

Poverty: Estimated number of people of all ages in poverty 2021.

Unemployed: Unemployment in 2021.

Population: 4/1/2020 resident Census 2020 population.

Median Income: Estimate of median household income in 2021.

Total Deaths: Death number in period 7/1/2020 to 6/30/2021.

Higher Education: Number of adults with a bachelor's degree or higher, 2017-21.

```{r}
#| message: false
here::i_am("Group_Project.Rproj")
library(here)
library(vroom)
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(stringr)
theme_set(theme_bw())
```

## Data Loading

```{r}
health <- vroom(here("data", "analytic_data2021.csv"))
cases <- vroom(here("data", "covid_confirmed_usafacts.csv"))
deaths <- vroom(here("data", "covid_deaths_usafacts.csv"))
edu <- vroom(here("data", "Education.csv"))
pop <- vroom(here("data", "PopulationEstimates.csv"))
pov <- vroom(here("data", "PovertyEstimates.csv"))
ump <- vroom(here("data", "Unemployment.csv"))
```

## Basic information about the data files

```{r}
info_health <- data.frame(file_name='health',row_number=nrow(health),col_number=ncol(health))
knitr::kable(info_health)
```

```{r}
info_cases <- data.frame(file_name='cases',row_number=nrow(cases),col_number=ncol(cases))
knitr::kable(info_cases)
```

```{r}
info_deaths <- data.frame(file_name='deaths',row_number=nrow(deaths),col_number=ncol(deaths))
knitr::kable(info_deaths)
```

```{r}
info_edu <- data.frame(file_name='edu',row_number=nrow(edu),col_number=ncol(edu))
knitr::kable(info_edu)
```

```{r}
info_pop <- data.frame(file_name='pop',row_number=nrow(pop),col_number=ncol(pop))
knitr::kable(info_pop)
```

```{r}
info_pov <- data.frame(file_name='pov',row_number=nrow(pov),col_number=ncol(pov))
knitr::kable(info_pov)
```

```{r}
info_ump <- data.frame(file_name='ump',row_number=nrow(ump),col_number=ncol(ump))
knitr::kable(info_ump)
```

## Data cleaning

```{r}
cov_clean <- function(df) {
  df$countyFIPS <- df$countyFIPS |>
    as.character() |>
    str_pad(5, pad = "0")
  
 df$countyFIPS <- ifelse(df$`County Name` == "Statewide Unallocated", "99999", df$countyFIPS)

  df <- df |>
    select(
      countyFIPS, `County Name`, State, StateFIPS,
      `2020-07-31`, `2020-08-31`, `2020-09-30`, `2020-10-31`,
      `2020-11-30`, `2020-12-31`, `2021-01-31`, `2021-02-28`,
      `2021-03-31`, `2021-04-30`, `2021-05-31`, `2021-06-30`
    ) |>
    rename(
      `2020-07` = `2020-07-31`,
      `2020-08` = `2020-08-31`,
      `2020-09` = `2020-09-30`,
      `2020-10` = `2020-10-31`,
      `2020-11` = `2020-11-30`,
      `2020-12` = `2020-12-31`,
      `2021-01` = `2021-01-31`,
      `2021-02` = `2021-02-28`,
      `2021-03` = `2021-03-31`,
      `2021-04` = `2021-04-30`,
      `2021-05` = `2021-05-31`,
      `2021-06` = `2021-06-30`
    )
  
US <- data.frame(
  countyFIPS = "00000", 
  `County Name` = "United States", 
  State = NA, 
  StateFIPS = NA,
  `2020-07` = NA,
  `2020-08` = NA,
  `2020-09` = NA,
  `2020-10` = NA,
  `2020-11` = NA,
  `2020-12` = NA,
  `2021-01` = NA,
  `2021-02` = NA,
  `2021-03` = NA,
  `2021-04` = NA,
  `2021-05` = NA,
  `2021-06` = NA,
  check.names = FALSE
)

df <- bind_rows(US, df)


}
```

```{r}
cases_mon <- cov_clean(cases)
deaths_mon <- cov_clean(deaths)
```

```{r}
edu_c <- edu |> select(`Federal Information Processing Standard (FIPS) Code`, `Bachelor's degree or higher, 2017-21`) |>
  rename(countyFIPS = `Federal Information Processing Standard (FIPS) Code`,
         `Higher Education` = `Bachelor's degree or higher, 2017-21`
         )
```

```{r}
pop_c <- pop |> select(FIPStxt, CENSUS_2020_POP, DEATHS_2021) |>
  rename(countyFIPS = FIPStxt,
         Population = CENSUS_2020_POP,
         `Total Deaths` = DEATHS_2021)
```

```{r}
pov_c <- pov |> select(FIPS_Code, POVALL_2021, MEDHHINC_2021) |>
  rename(countyFIPS = FIPS_Code,
         Poverty = POVALL_2021,
         `Median Income` = MEDHHINC_2021)
```

```{r}
ump_c <- ump |> select(FIPS_Code, Unemployed_2021) |>
  rename(countyFIPS = FIPS_Code,
          Unemployed  = Unemployed_2021)
```

```{r}
health_c <- health[2:nrow(health), ] |>
  mutate(countyFIPS = paste(`State FIPS Code`, `County FIPS Code`, sep = "")) |>
  select(countyFIPS,`Adult smoking raw value`,`Adult obesity raw value`,`Food environment index raw value`,`Physical inactivity raw value`,`Excessive drinking raw value`,`Uninsured raw value`,`Primary care physicians raw value`) |>
  rename(Smoke =`Adult smoking raw value`,
         Obesity =`Adult obesity raw value`,
         `Food Environment` =`Food environment index raw value`,
         `Physical inactivity` =`Physical inactivity raw value`,
         Drinking =`Excessive drinking raw value`,
         Uninsured =`Uninsured raw value`,
         `Primary care` =`Primary care physicians raw value`)
```

```{r}
cases_f <- cases_mon |> left_join(health_c, by = "countyFIPS") |>
  left_join(edu_c, by = "countyFIPS") |> 
  left_join(pop_c, by = "countyFIPS") |> 
  left_join(pov_c, by = "countyFIPS") |>
  left_join(ump_c, by = "countyFIPS")

deaths_f <- deaths_mon |> left_join(health_c, by = "countyFIPS") |>
  left_join(edu_c, by = "countyFIPS") |> 
  left_join(pop_c, by = "countyFIPS") |> 
  left_join(pov_c, by = "countyFIPS") |>
  left_join(ump_c, by = "countyFIPS")
```

## Graphic representation of target variables

```{r}
cases_mon |>
  group_by(State) |>
  summarise(across(starts_with("2020"), sum), across(starts_with("2021"), sum)) |>
  pivot_longer(cols = starts_with("202"), names_to = "month", values_to = "count") |>
  ggplot(aes(x = month, y = count, group = State, color = State)) + geom_line() +
  labs(title = "Total cases reported across all 50 states from July 2020 to June 2021") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(margin = margin(b = 40)))
```

```{r}
deaths_mon |>
  group_by(State) |>
  summarise(across(starts_with("2020"), sum), across(starts_with("2021"), sum)) |>
  pivot_longer(cols = starts_with("202"), names_to = "month", values_to = "count") |>
  ggplot(aes(x = month, y = count, group = State, color = State)) + geom_line() +
  labs(title = "Total deaths reported across all 50 states from July 2020 to June 2021") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(margin = margin(b = 40)))
```

```{r}
cases_mon |>
  group_by(State) |>
  summarise(across(starts_with("2020"), sum), across(starts_with("2021"), sum)) |>
  pivot_longer(cols = starts_with("202"), names_to = "month", values_to = "count") |>
  group_by(State) |>
  mutate_at(vars(count), list(~ .x - lag(.x))) |>
  na.omit() |>
  ggplot(aes(x = month, y = count, group = State, color = State)) + geom_line() +
  labs(title = "New cases reported across all 50 states from August 2020 to June 2021") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(margin = margin(b = 40)))
```

```{r}
deaths_mon |>
  group_by(State) |>
  summarise(across(starts_with("2020"), sum), across(starts_with("2021"), sum)) |>
  pivot_longer(cols = starts_with("202"), names_to = "month", values_to = "count") |>
  group_by(State) |>
  mutate_at(vars(count), list(~ .x - lag(.x))) |>
  na.omit() |>
  ggplot(aes(x = month, y = count, group = State, color = State)) + geom_line() +
  labs(title = "New deaths reported across all 50 states from August 2020 to June 2021") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(margin = margin(b = 40)))
```

```{r}
cases_mon |>
  summarise(across(starts_with("202"), sum)) |>
  pivot_longer(cols = starts_with("202"), names_to = "month", values_to = "count") |>
  ggplot(aes(x = month, y = count, group = 1)) + 
  geom_line() +
  labs(title = "Nationwide total cases reported from July 2020 to June 2021")
```

```{r}
deaths_mon |>
  summarise(across(starts_with("202"), sum)) |>
  pivot_longer(cols = starts_with("202"), names_to = "month", values_to = "count") |>
  ggplot(aes(x = month, y = count, group = 1)) + 
  geom_line() +
  labs(title = "Nationwide total deaths reported from July 2020 to June 2021")
```

```{r}
deaths_mon |>
  summarise(across(starts_with("202"), sum)) |>
  pivot_longer(cols = starts_with("202"), names_to = "month", values_to = "count") |>
  ggplot(aes(x = month, y = count, group = 1)) + 
  geom_line() +
  labs(title = "Nationwide total deaths reported from July 2020 to June 2021")
```

```{r}
cases_mon |>
  summarise(across(starts_with("202"), sum)) |>
  pivot_longer(cols = starts_with("202"), names_to = "month", values_to = "count") |>
  mutate_at(vars(count), list(~ .x - lag(.x))) |>
  na.omit() |>
  ggplot(aes(x = month, y = count, group = 1)) + 
  geom_line() +
  labs(title = "Nationwide new cases reported from August 2020 to June 2021")

```

```{r}
deaths_mon |>
  summarise(across(starts_with("202"), sum)) |>
  pivot_longer(cols = starts_with("202"), names_to = "month", values_to = "count") |>
  mutate_at(vars(count), list(~ .x - lag(.x))) |>
  na.omit() |>
  ggplot(aes(x = month, y = count, group = 1)) + 
  geom_line() +
  labs(title = "Nationwide new deaths reported from August 2020 to June 2021")
```
